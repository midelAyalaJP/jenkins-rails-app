pipeline {
    agent any
   

    options {
        timeout(time: 5, unit: 'MINUTES')
    }
    environment {
        ARTIFACT_ID = "estimaciones-rails:${env.BUILD_NUMBER}"
        PROJECT_DIR = "/home/midelaya/Projects/docker-server-4/apps/estimaciones-yntech/"
        BACKUP_DIR = "/home/midelaya/Projects/docker-server-4/backups/estimaciones-yntech/"
    }

    stages {
        stage('Create container for test') {
            steps {
                script {
                    sh'''
                        docker build -t ${ARTIFACT_ID} .
                    '''
                }
            }
        }
        stage('Run tests') {
            steps {
                withCredentials([
                    string(credentialsId: 'DB_URL_CONNECTION', variable: 'db_url'),
                    string(credentialsId: 'DB_STAGE_USERNAME', variable: 'db_username'),
                    string(credentialsId: 'DB_PASSWORD_STAGE', variable: 'db_password')
                    
                    ]) {
                         sh '''
                        
                           docker run --rm -e APP_DATABASE_HOST=${db_url} \
                            -e APP_DATABASE_USERNAME=${db_username} \
                            -e APP_DATABASE_PASSWORD=${db_password} \
                            -e APP_DATABASE_NAME_DEV=${APP_DATABASE_NAME_DEV} \
                            -e APP_DATABASE_NAME_TEST=${APP_DATABASE_NAME_TEST} \
                            -e APP_DATABASE_NAME_PRODUCTION=${APP_DATABASE_NAME_PRODUCTION} ${ARTIFACT_ID} bin/rails db:migrate RAILS_ENV=test
                        '''
                        sh '''
                        
                            docker run --rm -e APP_DATABASE_HOST=${db_url} \
                            -e APP_DATABASE_USERNAME=${db_username} \
                            -e APP_DATABASE_PASSWORD=${db_password} \
                            -e APP_DATABASE_NAME_DEV=${APP_DATABASE_NAME_DEV} \
                            -e APP_DATABASE_NAME_TEST=${APP_DATABASE_NAME_TEST} \
                            -e APP_DATABASE_NAME_PRODUCTION=${APP_DATABASE_NAME_PRODUCTION} ${ARTIFACT_ID} bundle exec rspec
                        '''
                        
                    }
               
                
            }
        }
        stage('Create backup'){
            steps{
                sh '''
                    mkdir -p ${BACKUP_DIR}
                    cp -rf ./* ${BACKUP_DIR}
                '''
            }
        }
        stage('Set files') {
            steps {
                catchError {
                    echo "catch error DONE:::::...."
                }
                withCredentials([
                    string(credentialsId: 'DB_URL_CONNECTION', variable: 'db_url'),
                    string(credentialsId: 'DB_STAGE_USERNAME', variable: 'db_username'),
                    string(credentialsId: 'DB_PASSWORD_STAGE', variable: 'db_password')
                    
                    ]) {

                    sh '''
                        docker exec serverrails bas -c ./clear-estimaciones.sh
                    '''

                    sh '''
                        mkdir /home/midelaya/Projects/docker-server-4/apps/estimaciones-yntech/
                        mv -f ./* /home/midelaya/Projects/docker-server-4/apps/estimaciones-yntech/
                        
                    '''

                    sh '''
                        cd /home/midelaya/Projects/docker-server-4/apps/estimaciones-yntech/ && echo "
                            #DEVISE
                            DEVISE_JWT_SECRET_KEY=c8c4c4fceaab612e922a723136e7fab6fe43be5b040d4ae351099521532c458e07b164a659d8ee419e46ed0219fb952136a80bd139e54f7b7cf40a34ac85b393


                            #DATABASE
                            APP_DATABASE_HOST=${db_url}
                            APP_DATABASE_USERNAME=${db_username}
                            APP_DATABASE_PASSWORD=${db_password}
                            APP_DATABASE_NAME_DEV=${APP_DATABASE_NAME_DEV}
                            APP_DATABASE_NAME_TEST=${APP_DATABASE_NAME_TEST}
                            APP_DATABASE_NAME_PRODUCTION=${APP_DATABASE_NAME_PRODUCTION}" > .env
                    '''
                }
               

               
                
            }
            post {
                success {
                    echo 'POST SUCCESS::....'
                }
                failure {
                    echo 'failed :........'
                }
            }
        }
        stage('DEPLOY'){
            steps{
                sh '''
                    docker exec serverrails bash -c ./deploy-stage.sh
                '''
              
                 sh '''
                    exit
                '''
            }
        }
    
    }
}